<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MandalaBurn - Laser CAD</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/lib/paper-full.min.js"></script>
</head>
<body>
    <!-- Menu Bar -->
    <div id="menu-bar">
        <div class="menu-group">
            <button class="menu-btn" data-menu="file">File</button>
            <button class="menu-btn" data-menu="edit">Edit</button>
            <button class="menu-btn" data-menu="tools">Tools</button>
            <button class="menu-btn" data-menu="view">View</button>
            <button class="menu-btn" data-menu="machine">Machine</button>
        </div>
        <div class="menu-title">MandalaBurn</div>
        <!-- Connection indicator in menu bar -->
        <div id="connection-status" class="conn-disconnected" title="Not connected">
            <span class="conn-dot"></span>
            <span class="conn-label">Disconnected</span>
        </div>
    </div>

    <!-- Dropdown menus -->
    <div id="menu-dropdown" class="menu-dropdown hidden">
        <!-- File menu -->
        <div class="menu-items" data-menu="file">
            <button data-action="new-project">New Project</button>
            <button data-action="open-project">Open Project...</button>
            <button data-action="save-project">Save Project</button>
            <div class="menu-separator"></div>
            <button data-action="import-svg">Import SVG...</button>
            <button data-action="export-svg">Export SVG</button>
            <button data-action="export-gcode">Export G-code</button>
        </div>
        <!-- Edit menu -->
        <div class="menu-items" data-menu="edit">
            <button data-action="undo">Undo <span class="shortcut">Ctrl+Z</span></button>
            <button data-action="redo">Redo <span class="shortcut">Ctrl+Shift+Z</span></button>
            <div class="menu-separator"></div>
            <button data-action="copy">Copy <span class="shortcut">Ctrl+C</span></button>
            <button data-action="cut">Cut <span class="shortcut">Ctrl+X</span></button>
            <button data-action="paste">Paste <span class="shortcut">Ctrl+V</span></button>
            <button data-action="duplicate">Duplicate <span class="shortcut">Ctrl+D</span></button>
            <div class="menu-separator"></div>
            <button data-action="select-all">Select All <span class="shortcut">Ctrl+A</span></button>
            <button data-action="delete-selected">Delete <span class="shortcut">Del</span></button>
            <div class="menu-separator"></div>
            <button data-action="group-selected">Group <span class="shortcut">Ctrl+G</span></button>
            <button data-action="ungroup-selected">Ungroup <span class="shortcut">Ctrl+Shift+G</span></button>
            <div class="menu-separator"></div>
            <button data-action="align-left">Align Left</button>
            <button data-action="align-right">Align Right</button>
            <button data-action="align-top">Align Top</button>
            <button data-action="align-bottom">Align Bottom</button>
            <button data-action="align-center-h">Center Horizontal</button>
            <button data-action="align-center-v">Center Vertical</button>
            <button data-action="distribute-h">Distribute Horizontal</button>
            <button data-action="distribute-v">Distribute Vertical</button>
            <div class="menu-separator"></div>
            <button data-action="split-to-layer">Split Selection to New Layer</button>
            <button data-action="move-to-layer">Move Selection to Layer...</button>
            <button data-action="merge-layers">Merge Layer Down</button>
        </div>
        <!-- Tools menu (boolean ops + path ops) -->
        <div class="menu-items" data-menu="tools">
            <button data-action="bool-unite">Unite (Union)</button>
            <button data-action="bool-subtract">Subtract (Difference)</button>
            <button data-action="bool-intersect">Intersect</button>
            <button data-action="bool-exclude">Exclude (XOR)</button>
            <button data-action="bool-divide">Divide</button>
            <div class="menu-separator"></div>
            <button data-action="path-reverse">Reverse Path</button>
            <button data-action="path-simplify">Simplify Path</button>
            <button data-action="path-flatten">Flatten Path</button>
            <div class="menu-separator"></div>
            <button data-action="path-offset">Path Offset / Inset...</button>
            <button data-action="array-pattern">Array / Pattern...</button>
        </div>
        <!-- Machine menu -->
        <div class="menu-items" data-menu="machine">
            <button data-action="machine-settings">Machine Settings...</button>
            <button data-action="machine-connect">Connect / Disconnect</button>
            <div class="menu-separator"></div>
            <button data-action="machine-home">Home <span class="shortcut">Ctrl+H</span></button>
            <button data-action="machine-set-origin">Set Origin Here</button>
            <button data-action="machine-goto-origin">Go to Origin</button>
            <div class="menu-separator"></div>
            <button data-action="machine-frame">Frame Job (trace outline)</button>
        </div>
        <!-- View menu -->
        <div class="menu-items" data-menu="view">
            <button data-action="zoom-in">Zoom In <span class="shortcut">Ctrl++</span></button>
            <button data-action="zoom-out">Zoom Out <span class="shortcut">Ctrl+-</span></button>
            <button data-action="zoom-fit">Zoom to Fit <span class="shortcut">Ctrl+0</span></button>
            <div class="menu-separator"></div>
            <button data-action="toggle-grid">Toggle Grid <span class="shortcut">G</span></button>
            <button data-action="toggle-snap">Toggle Snap <span class="shortcut">S</span></button>
        </div>
    </div>

    <div id="main-container">
        <!-- Left Toolbar -->
        <div id="toolbar">
            <!-- Select section -->
            <span class="toolbar-label">Select</span>
            <button class="tool-btn active" data-tool="select" title="Select (V)">
                <svg viewBox="0 0 24 24"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51z"/></svg>
            </button>
            <button class="tool-btn" data-tool="node-edit" title="Node Edit (N)">
                <svg viewBox="0 0 24 24"><circle cx="6" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="18" cy="18" r="3" fill="none" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="8" x2="16" y2="16" stroke="currentColor" stroke-width="1.5"/></svg>
            </button>
            <div class="toolbar-separator"></div>
            <!-- Draw section -->
            <span class="toolbar-label">Draw</span>
            <button class="tool-btn" data-tool="line" title="Line (L)">
                <svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="pen" title="Pen / Bezier (P)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 18C3 18 8 4 12 12S21 6 21 6" stroke-linecap="round"/><circle cx="3" cy="18" r="2" fill="currentColor" stroke="none"/><circle cx="21" cy="6" r="2" fill="currentColor" stroke="none"/><line x1="3" y1="18" x2="8" y2="4" stroke-dasharray="2,2" stroke-width="1"/><circle cx="8" cy="4" r="1.5" fill="none"/></svg>
            </button>
            <button class="tool-btn" data-tool="rect" title="Rectangle (R)">
                <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="circle" title="Circle (C)">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            </button>
            <button class="tool-btn" data-tool="polygon" title="Polygon/Star (Q)">
                <svg viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            </button>
            <button class="tool-btn" data-tool="text" title="Text (T)">
                <svg viewBox="0 0 24 24"><text x="5" y="19" font-size="18" font-weight="bold" fill="currentColor" font-family="sans-serif">T</text></svg>
            </button>
            <div class="toolbar-separator"></div>
            <!-- Transform section -->
            <span class="toolbar-label">Xform</span>
            <button class="tool-btn" data-tool="select" data-transform-mode="move" title="Move (1)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3 3h-2v4h4v-2l3 3-3 3v-2h-4v4h2l-3 3-3-3h2v-4H7v2l-3-3 3-3v2h4V5H9l3-3z"/></svg>
            </button>
            <button class="tool-btn" data-tool="select" data-transform-mode="scale" title="Scale (2)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="13" width="8" height="8" rx="1"/><path d="M14 10l-4-4M10 6h4v4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="tool-btn" data-tool="select" data-transform-mode="rotate" title="Rotate (3)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
            </button>
            <div class="toolbar-separator"></div>
            <!-- Utility section -->
            <span class="toolbar-label">Util</span>
            <button class="tool-btn" data-tool="ruler" title="Measure (M)">
                <svg viewBox="0 0 24 24"><path d="M3 5h18v14H3V5zm2 2v10h14V7H5zm2 2h2v2H7V9zm4 0h2v2h-2V9zm4 0h2v2h-2V9zm-8 4h2v2H7v-2zm4 0h2v2h-2v-2z" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>
            </button>
            <div class="toolbar-separator"></div>
            <!-- Mandala section -->
            <span class="toolbar-label">Mandala</span>
            <button class="tool-btn" data-tool="mandala" title="Mandala (D)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="2" x2="12" y2="22"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <line x1="4.9" y1="4.9" x2="19.1" y2="19.1"/>
                    <line x1="19.1" y1="4.9" x2="4.9" y2="19.1"/>
                </svg>
            </button>
            <div class="toolbar-separator"></div>
            <!-- Boolean ops section -->
            <span class="toolbar-label">Bool</span>
            <button class="tool-btn" data-action="bool-unite" title="Unite">
                <svg viewBox="0 0 24 24"><circle cx="9" cy="10" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="15" cy="14" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/></svg>
            </button>
            <button class="tool-btn" data-action="bool-subtract" title="Subtract">
                <svg viewBox="0 0 24 24"><circle cx="9" cy="10" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="15" cy="14" r="6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-dasharray="3,2"/></svg>
            </button>
        </div>

        <!-- Tool Options Panel (expandable) -->
        <div id="tool-options" class="hidden">
            <!-- Select tool options -->
            <div class="tool-opts" data-tool="select">
                <div class="tool-opts-title">Transform</div>
                <div class="to-btn-group">
                    <button class="to-btn active" data-mode="move" title="Move (1)">Move</button>
                    <button class="to-btn" data-mode="scale" title="Scale (2)">Scale</button>
                    <button class="to-btn" data-mode="rotate" title="Rotate (3)">Rotate</button>
                </div>
                <div id="scale-opts" class="tool-opts-sub hidden">
                    <div class="prop-row">
                        <label><input type="checkbox" id="lock-aspect" checked> Lock ratio</label>
                    </div>
                </div>
                <div id="rotate-opts" class="tool-opts-sub hidden">
                    <div class="prop-row">
                        <label>Angle</label>
                        <input type="number" id="rotate-angle" step="1" value="0" style="width:50px">
                        <span>&deg;</span>
                    </div>
                    <div class="to-btn-group">
                        <button class="to-btn" data-rotate="45">45&deg;</button>
                        <button class="to-btn" data-rotate="90">90&deg;</button>
                        <button class="to-btn" data-rotate="180">180&deg;</button>
                    </div>
                    <div class="prop-row" style="margin-top:2px">
                        <label><input type="checkbox" id="rotate-snap-15"> Snap 15&deg;</label>
                    </div>
                </div>
            </div>
            <!-- Pen tool options -->
            <div class="tool-opts" data-tool="pen">
                <div class="tool-opts-title">Pen</div>
                <div class="prop-row">
                    <label><input type="checkbox" id="pen-smooth"> Smooth</label>
                </div>
                <div class="prop-row">
                    <button class="to-btn" id="pen-close-path">Close Path</button>
                </div>
                <div class="prop-row" id="pen-info" style="font-size:10px;color:var(--text-muted)">
                    <span id="pen-seg-count">Pts: 0</span>
                    <span id="pen-length">Len: 0</span>
                </div>
            </div>
            <!-- Ruler tool options -->
            <div class="tool-opts" data-tool="ruler">
                <div class="tool-opts-title">Measure</div>
                <div class="prop-row">
                    <label>Dist</label>
                    <span id="ruler-distance" class="measure-val">&mdash;</span>
                </div>
                <div class="prop-row">
                    <label>dX</label><span id="ruler-dx" class="measure-val">&mdash;</span>
                </div>
                <div class="prop-row">
                    <label>dY</label><span id="ruler-dy" class="measure-val">&mdash;</span>
                </div>
                <div class="prop-row">
                    <label>Angle</label>
                    <span id="ruler-angle" class="measure-val">&mdash;</span>
                </div>
                <div class="prop-row" style="margin-top:4px">
                    <button class="to-btn" id="ruler-clear">Clear</button>
                </div>
            </div>
            <!-- Node-edit tool options -->
            <div class="tool-opts" data-tool="node-edit">
                <div class="tool-opts-title">Node Edit</div>
                <div class="to-btn-group">
                    <button class="to-btn" id="ne-corner" title="Corner (C)" disabled>Corner</button>
                    <button class="to-btn" id="ne-smooth" title="Smooth (S)" disabled>Smooth</button>
                    <button class="to-btn" id="ne-cusp" title="Cusp (B)" disabled>Cusp</button>
                </div>
                <div class="to-btn-group" style="margin-top:4px">
                    <button class="to-btn" id="ne-add" title="Add node (click on path)" disabled>+ Add</button>
                    <button class="to-btn" id="ne-del" title="Delete selected nodes" disabled>- Del</button>
                </div>
                <div class="to-btn-group" style="margin-top:4px">
                    <button class="to-btn" id="ne-close" title="Close open path" disabled>Close</button>
                    <button class="to-btn" id="ne-open" title="Open closed path" disabled>Open</button>
                    <button class="to-btn" id="ne-break" title="Break path into 2" disabled>Break</button>
                </div>
                <div class="to-btn-group" style="margin-top:4px">
                    <button class="to-btn" id="ne-reverse" title="Reverse direction" disabled>Reverse</button>
                </div>
                <div class="to-btn-group" style="margin-top:4px">
                    <button class="to-btn" id="ne-simplify" title="Simplify path" disabled>Simplify</button>
                    <button class="to-btn" id="ne-flatten" title="Flatten curves" disabled>Flatten</button>
                </div>
                <div class="prop-row" style="margin-top:4px">
                    <label>Tol</label>
                    <input type="number" id="ne-tolerance" value="2.5" min="0.1" max="50" step="0.5" style="width:55px">
                </div>
                <div class="prop-row" id="ne-info" style="font-size:10px;color:var(--text-muted)">
                    <span id="ne-seg-count">Nodes: 0</span>
                    <span id="ne-path-len">Len: 0</span>
                </div>
            </div>
            <!-- Polygon tool options -->
            <div class="tool-opts" data-tool="polygon">
                <div class="tool-opts-title">Polygon</div>
                <div class="prop-row">
                    <label>Sides</label>
                    <input type="number" id="polygon-sides" value="5" min="3" max="64" step="1" style="width:50px">
                </div>
                <div class="prop-row">
                    <label><input type="checkbox" id="polygon-star"> Star</label>
                </div>
                <div class="prop-row hidden" id="star-ratio-label">
                    <label>Ratio</label>
                    <input type="range" id="star-inner-ratio" min="0.1" max="0.9" step="0.05" value="0.5" style="flex:1">
                </div>
            </div>
            <!-- Text tool options -->
            <div class="tool-opts" data-tool="text">
                <div class="tool-opts-title">Text</div>
                <div class="prop-row">
                    <textarea id="text-input" rows="3" placeholder="Type text here..." style="width:100%;resize:vertical;font-size:12px"></textarea>
                </div>
                <div class="prop-row">
                    <label>Font</label>
                    <select id="text-font" style="flex:1">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="prop-row">
                    <label></label>
                    <label class="to-btn" style="text-align:center;cursor:pointer;font-size:10px">
                        Upload .ttf
                        <input type="file" id="text-font-upload" accept=".ttf,.otf,.woff" style="display:none">
                    </label>
                </div>
                <div class="prop-row">
                    <label>Size</label>
                    <input type="number" id="text-size" value="20" min="1" max="500" step="1" style="width:55px">
                    <span class="unit-label">mm</span>
                </div>
                <div class="prop-row">
                    <label>Spacing</label>
                    <input type="number" id="text-spacing" value="0" min="-10" max="50" step="0.5" style="width:55px">
                    <span class="unit-label">mm</span>
                </div>
                <div class="prop-row">
                    <label>Line H</label>
                    <input type="number" id="text-line-height" value="1.3" min="0.5" max="5" step="0.1" style="width:55px">
                </div>
                <div class="prop-row">
                    <label><input type="checkbox" id="text-unite" checked> Unite overlaps</label>
                </div>
            </div>
            <!-- Mandala tool options -->
            <div class="tool-opts" data-tool="mandala">
                <div class="tool-opts-title">Mandala</div>
                <div class="prop-row">
                    <label>Segments</label>
                    <input type="number" id="mandala-segments" value="8" min="0" max="64" step="1" style="width:50px">
                </div>
                <div class="prop-row">
                    <div class="btn-group" id="mandala-seg-presets">
                        <button class="bg-btn" data-val="0">Off</button>
                        <button class="bg-btn" data-val="4">4</button>
                        <button class="bg-btn" data-val="6">6</button>
                        <button class="bg-btn active" data-val="8">8</button>
                        <button class="bg-btn" data-val="12">12</button>
                        <button class="bg-btn" data-val="16">16</button>
                    </div>
                </div>
                <div class="prop-row">
                    <label><input type="checkbox" id="mandala-mirror" checked> Mirror</label>
                </div>
                <div class="prop-row">
                    <label><input type="checkbox" id="mandala-guides" checked> Guides</label>
                </div>
                <div class="prop-row">
                    <label><input type="checkbox" id="mandala-rings" checked> Rings</label>
                </div>
                <div class="prop-row">
                    <label>Ring gap</label>
                    <input type="number" id="mandala-ring-spacing" value="20" min="5" max="200" step="5" style="width:50px">
                    <span class="unit-label">mm</span>
                </div>
                <div class="prop-row">
                    <label>Center</label>
                    <input type="number" id="mandala-cx" step="0.1" style="width:50px" placeholder="X">
                    <input type="number" id="mandala-cy" step="0.1" style="width:50px" placeholder="Y">
                </div>
                <div class="prop-row">
                    <button class="to-btn" id="mandala-set-center">Click to set center</button>
                </div>
                <div class="prop-row">
                    <button class="to-btn" id="mandala-flatten" style="background:var(--accent);color:white">&#x2B07; Flatten to object</button>
                </div>
                <div class="prop-row" style="font-size:10px;color:var(--text-muted)">
                    Set center, then draw with any tool. Symmetry stays active.
                    Flatten converts mirrors into permanent items.
                </div>

                <!-- Curve Generators -->
                <div style="border-top:1px solid var(--border);margin:6px 0"></div>
                <div class="tool-opts-title">Generators</div>
                <div class="prop-row">
                    <select id="gen-type" style="flex:1">
                        <option value="spirograph">Spirograph</option>
                        <option value="rose">Rose curve</option>
                        <option value="lissajous">Lissajous</option>
                        <option value="harmonograph">Harmonograph</option>
                        <option value="guilloche">Guilloche</option>
                    </select>
                </div>
                <div class="prop-row">
                    <select id="gen-preset" style="flex:1">
                        <option value="">Custom</option>
                    </select>
                </div>

                <!-- Spirograph params -->
                <div id="gen-spirograph" class="gen-params">
                    <div class="prop-row"><label>R</label><input type="number" id="gen-sp-R" value="50" min="5" max="200" step="1" style="width:50px" title="Fixed circle radius"></div>
                    <div class="prop-row"><label>r</label><input type="number" id="gen-sp-r" value="20" min="1" max="100" step="1" style="width:50px" title="Rolling circle radius"></div>
                    <div class="prop-row"><label>d</label><input type="number" id="gen-sp-d" value="15" min="0.1" max="100" step="0.5" style="width:50px" title="Pen offset"></div>
                    <div class="prop-row"><label><input type="checkbox" id="gen-sp-epi"> Epi</label></div>
                </div>

                <!-- Rose params -->
                <div id="gen-rose" class="gen-params hidden">
                    <div class="prop-row"><label>Size</label><input type="number" id="gen-rs-a" value="50" min="5" max="200" step="1" style="width:50px"></div>
                    <div class="prop-row"><label>n</label><input type="number" id="gen-rs-n" value="3" min="1" max="20" step="1" style="width:50px" title="Numerator (petals)"></div>
                    <div class="prop-row"><label>d</label><input type="number" id="gen-rs-d" value="1" min="1" max="20" step="1" style="width:50px" title="Denominator"></div>
                </div>

                <!-- Lissajous params -->
                <div id="gen-lissajous" class="gen-params hidden">
                    <div class="prop-row"><label>W</label><input type="number" id="gen-li-A" value="50" min="5" max="200" step="1" style="width:50px" title="X amplitude"></div>
                    <div class="prop-row"><label>H</label><input type="number" id="gen-li-B" value="50" min="5" max="200" step="1" style="width:50px" title="Y amplitude"></div>
                    <div class="prop-row"><label>a</label><input type="number" id="gen-li-a" value="3" min="1" max="20" step="1" style="width:50px" title="X frequency"></div>
                    <div class="prop-row"><label>b</label><input type="number" id="gen-li-b" value="2" min="1" max="20" step="1" style="width:50px" title="Y frequency"></div>
                    <div class="prop-row"><label>&delta;</label><input type="range" id="gen-li-delta" min="0" max="360" step="5" value="0" style="flex:1"><span id="gen-li-delta-val" style="width:30px;text-align:right;font-size:10px">0&deg;</span></div>
                </div>

                <!-- Harmonograph params -->
                <div id="gen-harmonograph" class="gen-params hidden">
                    <div class="prop-row"><label>Size</label><input type="number" id="gen-ha-size" value="50" min="5" max="200" step="1" style="width:50px"></div>
                    <div class="prop-row"><label>fX</label><input type="number" id="gen-ha-fx" value="3" min="0.5" max="20" step="0.01" style="width:50px" title="X frequency"></div>
                    <div class="prop-row"><label>fY</label><input type="number" id="gen-ha-fy" value="2" min="0.5" max="20" step="0.01" style="width:50px" title="Y frequency"></div>
                    <div class="prop-row"><label>&phi;X</label><input type="number" id="gen-ha-px" value="0" min="0" max="360" step="5" style="width:50px" title="X phase"></div>
                    <div class="prop-row"><label>&phi;Y</label><input type="number" id="gen-ha-py" value="0" min="0" max="360" step="5" style="width:50px" title="Y phase"></div>
                    <div class="prop-row"><label>Dcy</label><input type="range" id="gen-ha-decay" min="0.001" max="0.1" step="0.001" value="0.02" style="flex:1"><span id="gen-ha-decay-val" style="width:35px;text-align:right;font-size:10px">0.020</span></div>
                </div>

                <!-- Guilloche params -->
                <div id="gen-guilloche" class="gen-params hidden">
                    <div class="prop-row"><label>R</label><input type="number" id="gen-gu-R" value="50" min="5" max="200" step="1" style="width:50px"></div>
                    <div class="prop-row"><label>r</label><input type="number" id="gen-gu-r" value="15" min="1" max="100" step="1" style="width:50px"></div>
                    <div class="prop-row"><label>d1</label><input type="number" id="gen-gu-d1" value="10" min="0.1" max="100" step="0.5" style="width:50px" title="Inner pen offset"></div>
                    <div class="prop-row"><label>d2</label><input type="number" id="gen-gu-d2" value="20" min="0.1" max="100" step="0.5" style="width:50px" title="Outer pen offset"></div>
                    <div class="prop-row"><label>Lines</label><input type="number" id="gen-gu-lines" value="80" min="20" max="500" step="10" style="width:50px"></div>
                </div>

                <div class="prop-row">
                    <button class="to-btn" id="gen-generate" style="background:var(--accent);color:white;flex:1">&#x2728; Generate</button>
                </div>
                <div class="prop-row" style="font-size:10px;color:var(--text-muted)">
                    Creates curve at mandala center (or canvas center).
                </div>
            </div>
        </div>

        <!-- Canvas Area with Edge Rulers -->
        <div id="canvas-area">
            <div id="ruler-corner"></div>
            <canvas id="ruler-h" height="20"></canvas>
            <canvas id="ruler-v" width="20"></canvas>
            <div id="canvas-container">
                <canvas id="main-canvas"></canvas>
            </div>
        </div>

        <!-- Right Panel -->
        <div id="right-panel">
            <!-- Objects List -->
            <div class="panel-section" id="objects-panel">
                <div class="panel-header collapsible">Objects <span class="collapse-arrow"></span></div>
                <div class="panel-body" style="padding: 0;">
                    <div id="objects-list"></div>
                </div>
            </div>

            <!-- Object Properties -->
            <div class="panel-section collapsed" id="object-properties">
                <div class="panel-header collapsible">Object<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <div class="prop-row">
                        <label>X</label><input type="number" id="prop-x" step="0.1" disabled>
                        <label>Y</label><input type="number" id="prop-y" step="0.1" disabled>
                    </div>
                    <div class="prop-row">
                        <label>W</label><input type="number" id="prop-w" step="0.1" disabled>
                        <button id="prop-lock-wh" class="lt-toggle on" title="Lock aspect ratio">&#x1F512;</button>
                        <label>H</label><input type="number" id="prop-h" step="0.1" disabled>
                    </div>
                    <div class="prop-row">
                        <label>R</label><input type="number" id="prop-r" step="1" disabled>
                        <label>&deg;</label>
                    </div>
                    <div class="prop-row" id="prop-length-row" style="display:none">
                        <label>Len</label><span id="prop-length">&mdash;</span><span class="unit-label">mm</span>
                    </div>

                    <!-- Parametric shape properties -->
                    <div id="param-props" class="hidden">
                        <div class="prop-row" style="margin-top:6px;border-top:1px solid var(--border);padding-top:6px">
                            <span id="param-type-label" style="font-size:10px;color:var(--accent);text-transform:uppercase;flex:1">Shape</span>
                            <button id="param-flatten-btn" class="to-btn" style="font-size:10px" title="Convert to plain path">&rarr; Path</button>
                        </div>

                        <div id="param-rect" class="param-group hidden">
                            <div class="prop-row">
                                <label>Width</label><input type="number" id="param-rect-w" step="0.1" min="0.1" style="width:60px">
                            </div>
                            <div class="prop-row">
                                <label>Height</label><input type="number" id="param-rect-h" step="0.1" min="0.1" style="width:60px">
                            </div>
                        </div>

                        <div id="param-ellipse" class="param-group hidden">
                            <div class="prop-row">
                                <label>Radius X</label><input type="number" id="param-ellipse-rx" step="0.1" min="0.1" style="width:60px">
                            </div>
                            <div class="prop-row">
                                <label>Radius Y</label><input type="number" id="param-ellipse-ry" step="0.1" min="0.1" style="width:60px">
                            </div>
                        </div>

                        <div id="param-polygon" class="param-group hidden">
                            <div class="prop-row">
                                <label>Sides</label><input type="number" id="param-poly-sides" min="3" max="64" step="1" style="width:50px">
                            </div>
                            <div class="prop-row">
                                <label>Radius</label><input type="number" id="param-poly-radius" step="0.1" min="0.1" style="width:60px">
                            </div>
                            <div class="prop-row">
                                <label><input type="checkbox" id="param-poly-star"> Star</label>
                            </div>
                            <div class="prop-row" id="param-poly-ratio-row">
                                <label>Inner</label>
                                <input type="range" id="param-poly-ratio" min="0.1" max="0.9" step="0.05" value="0.5" style="flex:1">
                                <span id="param-poly-ratio-val" style="width:30px;text-align:right;font-size:10px">0.50</span>
                            </div>
                        </div>

                        <div id="param-text" class="param-group hidden">
                            <div class="prop-row">
                                <textarea id="param-text-content" rows="2" style="width:100%;resize:vertical;font-size:11px" placeholder="Text..."></textarea>
                            </div>
                            <div class="prop-row">
                                <label>Font</label><select id="param-text-font" style="flex:1"></select>
                            </div>
                            <div class="prop-row">
                                <label>Size</label><input type="number" id="param-text-size" min="1" max="500" step="1" style="width:55px">
                            </div>
                            <div class="prop-row">
                                <label>Space</label><input type="number" id="param-text-spacing" min="-10" max="50" step="0.5" style="width:55px">
                            </div>
                            <div class="prop-row">
                                <label>Line H</label><input type="number" id="param-text-line-h" min="0.5" max="5" step="0.1" style="width:55px">
                            </div>
                            <div class="prop-row">
                                <label><input type="checkbox" id="param-text-unite" checked> Unite</label>
                            </div>
                            <div class="prop-row" style="margin-top:4px;border-top:1px solid var(--border);padding-top:4px">
                                <span style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Transform</span>
                            </div>
                            <div class="prop-row">
                                <label>Arc</label>
                                <input type="range" id="param-text-arc" min="-360" max="360" step="5" value="0" style="flex:1">
                                <span id="param-text-arc-val" style="width:35px;text-align:right;font-size:10px">0&deg;</span>
                            </div>
                        </div>

                        <div id="param-spirograph" class="param-group hidden">
                            <div class="prop-row"><label>R</label><input type="number" id="param-sp-R" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>r</label><input type="number" id="param-sp-r" step="1" min="1" style="width:55px"></div>
                            <div class="prop-row"><label>d</label><input type="number" id="param-sp-d" step="0.5" min="0.1" style="width:55px"></div>
                            <div class="prop-row"><label><input type="checkbox" id="param-sp-epi"> Epi</label></div>
                        </div>

                        <div id="param-rose" class="param-group hidden">
                            <div class="prop-row"><label>Size</label><input type="number" id="param-rs-a" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>n</label><input type="number" id="param-rs-n" step="1" min="1" style="width:55px"></div>
                            <div class="prop-row"><label>d</label><input type="number" id="param-rs-d" step="1" min="1" style="width:55px"></div>
                        </div>

                        <div id="param-lissajous" class="param-group hidden">
                            <div class="prop-row"><label>A</label><input type="number" id="param-li-A" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>B</label><input type="number" id="param-li-B" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>a</label><input type="number" id="param-li-a" step="1" min="1" style="width:55px"></div>
                            <div class="prop-row"><label>b</label><input type="number" id="param-li-b" step="1" min="1" style="width:55px"></div>
                            <div class="prop-row"><label>&delta;</label><input type="number" id="param-li-delta" step="5" min="0" max="360" style="width:55px"></div>
                        </div>

                        <div id="param-harmonograph" class="param-group hidden">
                            <div class="prop-row"><label>Size</label><input type="number" id="param-ha-size" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>fX</label><input type="number" id="param-ha-fx" step="0.01" min="0.5" style="width:55px"></div>
                            <div class="prop-row"><label>fY</label><input type="number" id="param-ha-fy" step="0.01" min="0.5" style="width:55px"></div>
                            <div class="prop-row"><label>&phi;X</label><input type="number" id="param-ha-px" step="5" min="0" max="360" style="width:55px"></div>
                            <div class="prop-row"><label>&phi;Y</label><input type="number" id="param-ha-py" step="5" min="0" max="360" style="width:55px"></div>
                            <div class="prop-row"><label>Decay</label><input type="number" id="param-ha-decay" step="0.001" min="0.001" max="0.1" style="width:55px"></div>
                        </div>

                        <div id="param-guilloche" class="param-group hidden">
                            <div class="prop-row"><label>R</label><input type="number" id="param-gu-R" step="1" min="5" style="width:55px"></div>
                            <div class="prop-row"><label>r</label><input type="number" id="param-gu-r" step="1" min="1" style="width:55px"></div>
                            <div class="prop-row"><label>d1</label><input type="number" id="param-gu-d1" step="0.5" min="0.1" style="width:55px"></div>
                            <div class="prop-row"><label>d2</label><input type="number" id="param-gu-d2" step="0.5" min="0.1" style="width:55px"></div>
                            <div class="prop-row"><label>Lines</label><input type="number" id="param-gu-lines" step="10" min="20" max="500" style="width:55px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Symmetry Modifier -->
            <div class="panel-section collapsed" id="symmetry-panel">
                <div class="panel-header collapsible">Symmetry<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <div class="prop-row">
                        <label><input type="checkbox" id="sym-mirror-h" disabled> Mirror H</label>
                    </div>
                    <div class="prop-row">
                        <label><input type="checkbox" id="sym-mirror-v" disabled> Mirror V</label>
                    </div>
                    <div class="prop-row">
                        <label>Rotational</label>
                        <input type="number" id="sym-rotational" value="0" min="0" max="64" step="1" style="width:50px" disabled>
                    </div>
                    <div class="prop-row">
                        <div class="btn-group" id="sym-rot-presets">
                            <button class="bg-btn active" data-val="0">Off</button>
                            <button class="bg-btn" data-val="2">2</button>
                            <button class="bg-btn" data-val="3">3</button>
                            <button class="bg-btn" data-val="4">4</button>
                            <button class="bg-btn" data-val="6">6</button>
                            <button class="bg-btn" data-val="8">8</button>
                        </div>
                    </div>
                    <div class="prop-row">
                        <label>Axis</label>
                        <input type="number" id="sym-axis-angle" value="0" min="-180" max="180" step="5" style="width:55px" disabled>
                        <span>&deg;</span>
                    </div>
                    <div class="prop-row" style="margin-top:4px">
                        <button class="to-btn" id="sym-flatten-btn" style="background:var(--accent);color:white" disabled>&#x2B07; Flatten symmetry</button>
                    </div>
                    <div class="prop-row" style="margin-top:2px">
                        <button class="to-btn" id="sym-remove-btn" disabled>Remove symmetry</button>
                    </div>
                    <div class="prop-row" style="font-size:10px;color:var(--text-muted)">
                        Per-object symmetry. Copies are live until flattened.
                    </div>
                </div>
            </div>

            <!-- Laser Settings -->
            <div class="panel-section collapsed" id="laser-settings">
                <div class="panel-header collapsible">Laser Settings<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <div class="prop-row">
                        <label>Mode</label>
                        <select id="laser-mode">
                            <option value="cut">Cut</option>
                            <option value="engrave">Engrave</option>
                            <option value="score">Score</option>
                        </select>
                    </div>
                    <div class="prop-row">
                        <label>Power</label>
                        <span id="laser-power-val">80%</span>
                    </div>
                    <div class="prop-row">
                        <input type="range" id="laser-power" min="0" max="100" value="80" style="width:100%">
                    </div>
                    <div class="prop-row">
                        <label>Speed</label>
                        <input type="number" id="laser-speed" min="1" max="10000" value="10" step="1">
                        <span>mm/s</span>
                    </div>
                    <div class="prop-row">
                        <label>Passes</label>
                        <input type="number" id="laser-passes" min="1" max="100" value="1" step="1">
                    </div>
                </div>
            </div>

            <!-- Grid & Snap Settings -->
            <div class="panel-section collapsed" id="grid-settings">
                <div class="panel-header collapsible">Grid & Snap<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <!-- Display mode -->
                    <div class="prop-row">
                        <label>Display</label>
                        <div class="btn-group" id="grid-display-mode">
                            <button class="bg-btn" data-val="lines" title="Lines">&#x2588;</button>
                            <button class="bg-btn active" data-val="dots" title="Dots">&#x2059;</button>
                            <button class="bg-btn" data-val="none" title="None">&#x2205;</button>
                        </div>
                    </div>
                    <!-- Grid spacing -->
                    <div class="prop-row">
                        <label>Grid</label>
                        <div class="btn-group" id="grid-size-presets">
                            <button class="bg-btn" data-val="1">1</button>
                            <button class="bg-btn" data-val="5">5</button>
                            <button class="bg-btn active" data-val="10">10</button>
                            <button class="bg-btn" data-val="25">25</button>
                            <button class="bg-btn" data-val="50">50</button>
                        </div>
                        <span class="unit-label">mm</span>
                    </div>
                    <div class="prop-row">
                        <label></label>
                        <input type="number" id="grid-size" value="10" step="0.1" min="0.1" max="1000">
                        <span class="unit-label">custom</span>
                    </div>
                    <!-- Snap toggle & resolution -->
                    <div class="prop-row">
                        <label>Snap</label>
                        <button class="snap-toggle-btn" id="snap-toggle">ON</button>
                    </div>
                    <div class="prop-row">
                        <label>Step</label>
                        <div class="btn-group" id="snap-step-presets">
                            <button class="bg-btn" data-val="0.1">0.1</button>
                            <button class="bg-btn" data-val="0.5">0.5</button>
                            <button class="bg-btn" data-val="1">1</button>
                            <button class="bg-btn" data-val="5">5</button>
                            <button class="bg-btn active" data-val="10">10</button>
                        </div>
                        <span class="unit-label">mm</span>
                    </div>
                    <div class="prop-row">
                        <label></label>
                        <input type="number" id="snap-step" value="10" step="0.01" min="0.01" max="1000">
                        <span class="unit-label">custom</span>
                    </div>
                    <!-- Object Snap -->
                    <div class="prop-row">
                        <label>Obj Snap</label>
                        <button class="snap-toggle-btn off" id="obj-snap-toggle">OFF</button>
                    </div>
                    <!-- Major grid multiplier -->
                    <div class="prop-row">
                        <label>Major</label>
                        <select id="grid-major">
                            <option value="0">Off</option>
                            <option value="2">x2</option>
                            <option value="5" selected>x5</option>
                            <option value="10">x10</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Simulator -->
            <div class="panel-section collapsed" id="simulator-panel">
                <div class="panel-header collapsible">Simulator<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <div class="sim-transport">
                        <button class="to-btn" id="sim-play" title="Play">&#9654; Play</button>
                        <button class="to-btn" id="sim-pause" title="Pause" disabled>&#9208;</button>
                        <button class="to-btn" id="sim-stop" title="Stop" disabled>&#9632;</button>
                    </div>
                    <div class="prop-row">
                        <label>Speed</label>
                        <div class="btn-group" id="sim-speed-group">
                            <button class="bg-btn active" data-speed="1">1x</button>
                            <button class="bg-btn" data-speed="2">2x</button>
                            <button class="bg-btn" data-speed="4">4x</button>
                            <button class="bg-btn" data-speed="8">8x</button>
                            <button class="bg-btn" data-speed="16">16x</button>
                            <button class="bg-btn" data-speed="32">32x</button>
                            <button class="bg-btn" data-speed="64">64x</button>
                        </div>
                    </div>
                    <div class="sim-progress-bar" id="sim-progress">
                        <div class="sim-progress-fill" id="sim-progress-fill"></div>
                    </div>
                    <div class="sim-time" id="sim-time">00:00 / 00:00</div>
                    <div class="sim-params">
                        <div class="sim-param"><span>Layer</span><span id="sim-layer">&mdash;</span></div>
                        <div class="sim-param"><span>Pass</span><span id="sim-pass">&mdash;</span></div>
                        <div class="sim-param"><span>Speed</span><span id="sim-speed">&mdash;</span></div>
                        <div class="sim-param"><span>Power</span><span id="sim-power">&mdash;</span></div>
                        <div class="sim-param"><span>Air</span><span id="sim-air">&mdash;</span></div>
                        <div class="sim-param"><span>Mode</span><span id="sim-mode">&mdash;</span></div>
                    </div>
                </div>
            </div>

            <!-- Job Control -->
            <div class="panel-section collapsed" id="job-panel">
                <div class="panel-header collapsible">Job Control<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <div class="sim-transport">
                        <button class="to-btn" id="job-start">Start</button>
                        <button class="to-btn" id="job-pause" disabled>Pause</button>
                        <button class="to-btn" id="job-stop" disabled>Stop</button>
                    </div>
                    <div class="sim-progress-bar" id="job-progress">
                        <div class="sim-progress-fill" id="job-progress-fill"></div>
                    </div>
                    <div class="sim-time" id="job-progress-text">0 / 0 lines (0%)</div>
                </div>
            </div>

            <!-- Laser Control (Jog) -->
            <div class="panel-section collapsed" id="jog-panel">
                <div class="panel-header collapsible">Laser Control<span class="collapse-arrow"></span></div>
                <div class="panel-body">
                    <!-- Jog arrows -->
                    <div class="jog-grid">
                        <button class="jog-btn" data-jog="home" title="Home">H</button>
                        <button class="jog-btn" data-jog="up" title="Y-">&#x25B2;</button>
                        <button class="jog-btn" data-jog="set-origin" title="Set Origin">O</button>
                        <button class="jog-btn" data-jog="left" title="X-">&#x25C0;</button>
                        <button class="jog-btn jog-center" data-jog="laser-toggle" title="Toggle laser pointer">&#x2316;</button>
                        <button class="jog-btn" data-jog="right" title="X+">&#x25B6;</button>
                        <button class="jog-btn" data-jog="goto-origin" title="Go to origin">&#x2302;</button>
                        <button class="jog-btn" data-jog="down" title="Y+">&#x25BC;</button>
                        <button class="jog-btn" data-jog="stop" title="Stop!">&#x25A0;</button>
                    </div>
                    <!-- Jog step size -->
                    <div class="prop-row" style="margin-top:6px">
                        <label>Step</label>
                        <select id="jog-step">
                            <option value="0.1">0.1 mm</option>
                            <option value="1" selected>1 mm</option>
                            <option value="5">5 mm</option>
                            <option value="10">10 mm</option>
                            <option value="50">50 mm</option>
                        </select>
                    </div>
                    <div class="prop-row">
                        <label>Speed</label>
                        <input type="number" id="jog-speed" value="1000" min="1" max="10000" step="100">
                        <span>mm/min</span>
                    </div>
                    <!-- Go to point -->
                    <div class="prop-row" style="margin-top:4px">
                        <label>Go to</label>
                        <input type="number" id="goto-x" placeholder="X" step="0.1" style="width:55px">
                        <input type="number" id="goto-y" placeholder="Y" step="0.1" style="width:55px">
                        <button class="jog-go-btn" id="goto-btn" title="Move to XY">Go</button>
                    </div>
                    <!-- Laser position readout -->
                    <div class="jog-position">
                        <span>Pos:</span>
                        <span id="laser-pos-x">X: ---</span>
                        <span id="laser-pos-y">Y: ---</span>
                    </div>
                </div>
            </div>

            <!-- Machine Settings shortcut -->
            <div class="panel-section">
                <div class="panel-body" style="padding:6px 10px">
                    <button class="panel-wide-btn" data-action="machine-settings">Machine Settings...</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom: Layer Panel (table layout with inline params) -->
    <div id="layer-panel">
        <div class="layer-toolbar">
            <div class="layer-toolbar-group">
                <button id="add-layer" title="Add Layer">+ Add</button>
                <button id="remove-layer" title="Remove Layer">- Remove</button>
                <button id="duplicate-layer" title="Duplicate Layer">Duplicate</button>
            </div>
            <div class="layer-toolbar-group">
                <button id="merge-layers" title="Merge selected layer down">Merge Down</button>
                <button id="merge-all-layers" title="Merge all visible layers">Merge All</button>
            </div>
            <div class="layer-toolbar-group">
                <button id="split-to-layer" title="Move selected objects to a new layer">Split to Layer</button>
                <button id="move-to-layer" title="Move selected objects to another layer">Move to...</button>
            </div>
            <div class="layer-toolbar-group">
                <button id="move-layer-up" title="Move layer up">&uarr;</button>
                <button id="move-layer-down" title="Move layer down">&darr;</button>
            </div>
        </div>
        <div id="layer-table-wrap">
            <table id="layer-table">
                <thead>
                    <tr>
                        <th class="lc-color"></th>
                        <th class="lc-name">Layer</th>
                        <th class="lc-mode">Mode</th>
                        <th class="lc-power">Power</th>
                        <th class="lc-speed">Speed</th>
                        <th class="lc-passes">Pass</th>
                        <th class="lc-air">Air</th>
                        <th class="lc-output">Out</th>
                        <th class="lc-vis">Vis</th>
                        <th class="lc-lock">Lock</th>
                    </tr>
                </thead>
                <tbody id="layer-list"></tbody>
            </table>
        </div>
    </div>

    <!-- Subtract base picker dialog -->
    <div id="subtract-picker-dialog" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-title">Subtract: pick the base object</div>
            <div class="modal-subtitle">The rest will be subtracted from it</div>
            <div id="subtract-picker-items"></div>
            <div class="modal-buttons">
                <button id="subtract-picker-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Move-to-layer dialog -->
    <div id="move-to-layer-dialog" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-title">Move selection to layer</div>
            <div id="move-to-layer-options"></div>
            <div class="modal-buttons">
                <button id="move-to-layer-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Array/Pattern Dialog -->
    <div id="array-dialog" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-title">Array / Pattern</div>
            <div class="to-btn-group" style="margin-bottom:8px">
                <button class="array-tab-btn to-btn active" data-tab="rect">Rectangular</button>
                <button class="array-tab-btn to-btn" data-tab="circ">Circular</button>
            </div>
            <div id="array-rect-opts">
                <div class="prop-row">
                    <label>Rows</label>
                    <input type="number" id="array-rows" value="3" min="1" max="50" step="1" style="width:55px">
                </div>
                <div class="prop-row">
                    <label>Cols</label>
                    <input type="number" id="array-cols" value="3" min="1" max="50" step="1" style="width:55px">
                </div>
                <div class="prop-row">
                    <label>Gap X</label>
                    <input type="number" id="array-gap-x" value="5" step="0.5" style="width:55px">
                    <span class="unit-label">mm</span>
                </div>
                <div class="prop-row">
                    <label>Gap Y</label>
                    <input type="number" id="array-gap-y" value="5" step="0.5" style="width:55px">
                    <span class="unit-label">mm</span>
                </div>
            </div>
            <div id="array-circ-opts" class="hidden">
                <div class="prop-row">
                    <label>Count</label>
                    <input type="number" id="array-circ-count" value="6" min="2" max="100" step="1" style="width:55px">
                </div>
                <div class="prop-row">
                    <label>Radius</label>
                    <input type="number" id="array-circ-radius" value="50" min="1" step="1" style="width:55px">
                    <span class="unit-label">mm</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="array-cancel">Cancel</button>
                <button id="array-apply" class="primary">Apply</button>
            </div>
        </div>
    </div>

    <!-- Path Offset Dialog -->
    <div id="offset-dialog" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="modal-title">Path Offset / Inset</div>
            <div class="prop-row">
                <label>Distance</label>
                <input type="number" id="offset-distance" value="2" step="0.5" style="width:60px">
                <span class="unit-label">mm</span>
            </div>
            <div class="prop-row" style="font-size:10px;color:var(--text-muted)">
                Positive = outward (offset), Negative = inward (inset)
            </div>
            <div class="modal-buttons">
                <button id="offset-cancel">Cancel</button>
                <button id="offset-apply" class="primary">Apply</button>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-coords">X: 0.0 Y: 0.0</span>
        <span id="status-zoom">100%</span>
        <span id="status-tool">Select</span>
        <span id="status-info"></span>
    </div>

    <!-- Canvas Context Menu -->
    <div id="canvas-context-menu" class="canvas-context-menu hidden">
        <button data-action="ctx-copy">Copy<span class="shortcut">Ctrl+C</span></button>
        <button data-action="ctx-cut">Cut<span class="shortcut">Ctrl+X</span></button>
        <button data-action="ctx-paste">Paste<span class="shortcut">Ctrl+V</span></button>
        <button data-action="ctx-duplicate">Duplicate<span class="shortcut">Ctrl+D</span></button>
        <div class="menu-separator"></div>
        <button data-action="group">Group<span class="shortcut">Ctrl+G</span></button>
        <button data-action="ungroup">Ungroup<span class="shortcut">Ctrl+Shift+G</span></button>
        <div class="menu-separator"></div>
        <button data-action="flatten-to-path">&rarr; Convert to Path</button>
        <button data-action="flatten-symmetry">&rarr; Flatten Symmetry</button>
        <div class="menu-separator"></div>
        <button data-action="delete-selected">Delete<span class="shortcut">Del</span></button>
    </div>

    <!-- Machine Settings Dialog -->
    <div id="machine-settings-dialog" class="modal-overlay hidden">
        <div class="modal-box modal-wide">
            <div class="modal-title">Machine Settings</div>
            <div class="settings-grid">
                <fieldset>
                    <legend>Machine</legend>
                    <div class="prop-row">
                        <label>Name</label>
                        <input type="text" id="ms-name" value="My Laser" placeholder="Machine name">
                    </div>
                    <div class="prop-row">
                        <label>Model</label>
                        <input type="text" id="ms-model" placeholder="e.g. Ortur LM3, K40...">
                    </div>
                    <div class="prop-row">
                        <label>Controller</label>
                        <select id="ms-controller">
                            <option value="grbl" selected>GRBL</option>
                            <option value="grbl-lpc">GRBL-LPC</option>
                            <option value="marlin">Marlin</option>
                        </select>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Work Area</legend>
                    <div class="prop-row">
                        <label>Width</label>
                        <input type="number" id="ms-width" value="300" min="10" max="5000" step="1">
                        <span>mm</span>
                    </div>
                    <div class="prop-row">
                        <label>Height</label>
                        <input type="number" id="ms-height" value="200" min="10" max="5000" step="1">
                        <span>mm</span>
                    </div>
                    <div class="prop-row">
                        <label>Origin</label>
                        <select id="ms-origin">
                            <option value="top-left" selected>Top-Left</option>
                            <option value="bottom-left">Bottom-Left</option>
                            <option value="center">Center</option>
                        </select>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Limits</legend>
                    <div class="prop-row">
                        <label>Max speed</label>
                        <input type="number" id="ms-max-speed" value="6000" min="1" max="100000" step="100">
                        <span>mm/min</span>
                    </div>
                    <div class="prop-row">
                        <label>Max power</label>
                        <input type="number" id="ms-max-power" value="1000" min="1" max="10000" step="1">
                        <span>S value</span>
                    </div>
                    <div class="prop-row">
                        <label>Resolution</label>
                        <input type="number" id="ms-resolution" value="0.1" min="0.001" max="1" step="0.001">
                        <span>mm/step</span>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Connection</legend>
                    <div class="prop-row">
                        <label>Port</label>
                        <select id="ms-port">
                            <option value="">-- Select --</option>
                        </select>
                        <button id="ms-refresh-ports" title="Refresh port list">&#x21bb;</button>
                    </div>
                    <div class="prop-row">
                        <label>Baud</label>
                        <select id="ms-baud">
                            <option value="9600">9600</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                            <option value="230400">230400</option>
                        </select>
                    </div>
                </fieldset>
            </div>
            <div class="modal-buttons">
                <button id="ms-cancel">Cancel</button>
                <button id="ms-save" class="primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Hidden inputs for workspace size (managed by Machine Settings) -->
    <input type="hidden" id="canvas-w" value="300">
    <input type="hidden" id="canvas-h" value="200">

    <!-- Hidden file inputs -->
    <input type="file" id="file-open-project" accept=".mandala,.json" style="display:none">
    <input type="file" id="file-import-svg" accept=".svg" style="display:none">

    <!-- Libraries -->
    <script src="/lib/opentype.min.js"></script>

    <!-- Application scripts -->
    <script src="/js/app.js"></script>
    <script src="/js/canvas.js"></script>
    <script src="/js/grid-snap.js"></script>
    <script src="/js/layers.js"></script>
    <script src="/js/properties.js"></script>
    <script src="/js/history.js"></script>
    <script src="/js/parametric.js"></script>
    <script src="/js/tools/select.js"></script>
    <script src="/js/tools/line.js"></script>
    <script src="/js/tools/pen.js"></script>
    <script src="/js/tools/rect.js"></script>
    <script src="/js/tools/circle.js"></script>
    <script src="/js/tools/polygon.js"></script>
    <script src="/js/tools/node-edit.js"></script>
    <script src="/js/tools/ruler.js"></script>
    <script src="/js/rulers.js"></script>
    <script src="/js/objects-list.js"></script>
    <script src="/js/boolean-ops.js"></script>
    <script src="/js/machine.js"></script>
    <script src="/js/project-io.js"></script>
    <script src="/js/font-manager.js"></script>
    <script src="/js/tools/text.js"></script>
    <script src="/js/simulator.js"></script>
    <script src="/js/mandala.js"></script>
    <script src="/js/symmetry.js"></script>
    <script src="/js/generators.js"></script>
    <script src="/js/align.js"></script>
    <script src="/js/gcode.js"></script>
    <script src="/js/job-sender.js"></script>
    <script src="/js/array-pattern.js"></script>
    <script src="/js/path-offset.js"></script>
</body>
</html>
